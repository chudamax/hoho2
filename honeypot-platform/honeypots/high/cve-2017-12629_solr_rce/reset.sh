#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/../../.." && pwd)"
HONEYPOT_ID="cve-2017-12629_solr_rce"
PACK="${ROOT_DIR}/packs/high/${HONEYPOT_ID}.yaml"
ARTIFACT_DIR="${ROOT_DIR}/run/artifacts/${HONEYPOT_ID}"
COMPOSE_DIR="${ROOT_DIR}/deploy/compose/${HONEYPOT_ID}"
COMPOSE_FILE="${COMPOSE_DIR}/docker-compose.yml"
PROJECT_NAME="hoho-${HONEYPOT_ID}"

if [ -f "${COMPOSE_FILE}" ]; then
  docker compose -p "${PROJECT_NAME}" -f "${COMPOSE_FILE}" down -v || true
fi

rm -rf "${ARTIFACT_DIR}" "${COMPOSE_DIR}"

(
  cd "${ROOT_DIR}"
  PYTHONPATH="packages/hoho_core:packages/hoho_runtime" python -m hoho_runtime.cli render-compose "${PACK}"
)

docker compose -p "${PROJECT_NAME}" -f "${COMPOSE_FILE}" up -d

echo "honeypot_id=${HONEYPOT_ID}"
echo "artifacts=run/artifacts/${HONEYPOT_ID}/"
