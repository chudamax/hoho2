const http = require('http');
const fs = require('fs');
const path = require('path');

const PORT = Number(process.env.PORT || 3000);
const cacheDir = '/var/lib/nextcache';

function persistPayload(name, body) {
  try {
    fs.mkdirSync(cacheDir, { recursive: true });
    const out = path.join(cacheDir, `${Date.now()}-${name}.txt`);
    fs.writeFileSync(out, body.slice(0, 65535), 'utf8');
  } catch (_) {
    // best effort honeypot payload sink
  }
}

function respondJson(res, status, payload) {
  res.writeHead(status, { 'content-type': 'application/json' });
  res.end(JSON.stringify(payload));
}

const server = http.createServer((req, res) => {
  const chunks = [];
  req.on('data', (chunk) => chunks.push(chunk));
  req.on('end', () => {
    const body = Buffer.concat(chunks).toString('utf8');

    if (req.url === '/') {
      res.writeHead(200, { 'content-type': 'text/html; charset=utf-8' });
      res.end('<!doctype html><html><body><h1>Next.js App Router</h1><p>RSC endpoint active.</p></body></html>');
      return;
    }

    if (req.method === 'POST' && req.url.startsWith('/_next/server-actions')) {
      persistPayload('server-action', body);
      respondJson(res, 500, {
        error: 'Internal Server Error',
        digest: 'RSC_SERVER_ACTION_FAILURE',
      });
      return;
    }

    if (req.url.startsWith('/_next/flight')) {
      persistPayload('flight', body);
      res.writeHead(200, { 'content-type': 'text/x-component' });
      res.end('0:["$","div",null,{"children":"flight stream"}]');
      return;
    }

    if (req.url.startsWith('/_next/data/')) {
      respondJson(res, 200, { pageProps: {}, buildId: 'react2shell-lure' });
      return;
    }

    respondJson(res, 404, { error: 'Not Found' });
  });
});

server.listen(PORT, '0.0.0.0', () => {
  console.log(`react2shell lure listening on ${PORT}`);
});
