#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/../../.." && pwd)"
PACK="packs/high/cve-2021-41773_42013_apache_traversal_rce.yaml"
PACK_ID="cve-2021-41773_42013_apache_traversal_rce"
SESSION_ID="$(date -u +%Y%m%dT%H%M%SZ)-$(openssl rand -hex 3)"
ARTIFACT_ROOT="${ROOT_DIR}/run/artifacts/high/${PACK_ID}/${SESSION_ID}"
OUT_DIR="${ROOT_DIR}/deploy/compose/${PACK_ID}"
COMPOSE_FILE="${OUT_DIR}/docker-compose.yml"

mkdir -p "${ARTIFACT_ROOT}"

if [ -f "${COMPOSE_FILE}" ]; then
  docker compose -f "${COMPOSE_FILE}" down -v || true
fi

(
  cd "${ROOT_DIR}"
  PYTHONPATH="packages/hoho_core:packages/hoho_runtime" python -m hoho_runtime.cli render-compose "${PACK}" \
    --artifacts-root "${ARTIFACT_ROOT}" \
    -o "${OUT_DIR}"
)

docker compose -f "${COMPOSE_FILE}" up -d

echo "session_id=${SESSION_ID}"
echo "artifacts=${ARTIFACT_ROOT}/${PACK_ID}"
